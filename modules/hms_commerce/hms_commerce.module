<?php
/**
 * @file
 *
 * Module file containing HMS Commerce hooks.
 */

use Drupal\hms_commerce\PremiumContentManager;

/**
 * Implements hook_library_info_build.
 *
 * Adds a JS library with dynamic source according to module settings.
 */
function hms_commerce_library_info_build() {
  $libraries = [];
  $settings = \Drupal::service('hms_commerce.settings');

  // Add digtap widget js.
  $widget_js = $settings->getApiUrl('digtap_widgets');
  if (!empty($widget_js)) {
    $libraries['products']['js'][$widget_js] = [
      'type' => 'external', 'minified' => TRUE];
  }

  // Add premium content js.
  $premium_content_js = $settings->getApiUrl('premium_content');
  if (!empty($premium_content_js)) {
    $libraries['premiumContent']['js'][$premium_content_js] = [
      'type' => 'external', 'minified' => TRUE];
  }
  return $libraries;
}

/**
 * Implements hook_entity_view_alter.
 *
 * Encrypt all premium fields on entity view.
 */
function hms_commerce_entity_view_alter(array &$build, Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display) {

  $manager = new PremiumContentManager($entity);
  $manager->encryptPremiumFields($build, \Drupal::service('hms_commerce.cryptor'));
  $manager->showTeaser($build);
}
